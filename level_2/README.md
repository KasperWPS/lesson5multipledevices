# Домашнее задание по теме "Дисковая подсистема"

## Задание повышенной сложности (**)

- Измененный Vagrantfile, который поднимает систему с подключенными дисками для создания RAID1.

## Листинг

Изначально в box generic/debian11 диск имеете таблицу разделов msdos. Из-за проблем возникающих при установке grub решил не тратить время и записать загрузочную запись на оба новых диска, а массив собирается из разделов.

`lsblk`
```
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda      8:0    0   128G  0 disk
├─sda1   8:1    0   487M  0 part /boot
├─sda2   8:2    0   1.9G  0 part [SWAP]
└─sda3   8:3    0 125.6G  0 part /
sdb      8:16   0    20G  0 disk
sdc      8:32   0    20G  0 disk
```

```
parted -s /dev/sdb mklabel msdos
parted -s /dev/sdc mklabel msdos

parted /dev/sdb mkpart primary ext4 0% 100%
parted /dev/sdc mkpart primary ext4 0% 100%

mdadm --create --verbose /dev/md0 -l 1 -n 2 /dev/sdb1 /dev/sdc1

echo "DEVICE partitions" > /etc/mdadm/mdadm.conf
mdadm --detail --scan >> /etc/mdadm/mdadm.conf

update-initramfs -u
```

`lsblk`
```
NAME    MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda       8:0    0   128G  0 disk
├─sda1    8:1    0   487M  0 part  /boot
├─sda2    8:2    0   1.9G  0 part  [SWAP]
└─sda3    8:3    0 125.6G  0 part  /
sdb       8:16   0    20G  0 disk
└─sdb1    8:17   0    20G  0 part
  └─md0   9:0    0    20G  0 raid1
sdc       8:32   0    20G  0 disk
└─sdc1    8:33   0    20G  0 part
  └─md0   9:0    0    20G  0 raid1
```

```
parted -s /dev/md0 mklabel gpt

parted /dev/md0 mkpart primary ext4 0% 512M
parted /dev/md0 mkpart primary ext4 513M 2606M
parted /dev/md0 mkpart primary ext4 2607M 100%

mkfs.ext4 /dev/md0p1
mkfs.ext4 /dev/md0p3
mkswap /dev/md0p2
```

`mount /dev/md0p3 /mnt`

```
dump -0f /mnt/root.img /
cd /mnt
restore -rf ./root.img
rm ./root.img
```

`mount /dev/md0p1 /mnt/boot`

```
dump -0f /mnt/boot/boot.img /boot
cd /mnt/boot
restore -rf ./boot.img
rm ./boot.img
```

`blkid`
```
/dev/sda1: UUID="e919b759-bc17-46b4-8e96-46db50940931" BLOCK_SIZE="1024" TYPE="ext4" PARTUUID="6d583a8f-01"
/dev/sda2: UUID="f45c1e36-c502-45b2-be36-e998a704c0b6" TYPE="swap" PARTUUID="6d583a8f-02"
/dev/sda3: UUID="3e53b113-3ad6-4dcc-b314-f878e038ddd4" BLOCK_SIZE="4096" TYPE="ext4" PARTUUID="6d583a8f-03"
/dev/sdc1: UUID="42c18d11-b0ef-2e7a-0cd2-466f27c07ef2" UUID_SUB="49b0debe-5021-20da-057a-769127f484d2" LABEL="disksubsystem:0" TYPE="linux_raid_member" PARTUUID="d2c9bc5f-01"
/dev/sdb1: UUID="42c18d11-b0ef-2e7a-0cd2-466f27c07ef2" UUID_SUB="cad99d6d-1e88-009c-ec7d-380a647ee755" LABEL="disksubsystem:0" TYPE="linux_raid_member" PARTUUID="df96f95a-01"
/dev/md0p1: UUID="13ed70e3-a531-4c30-9a3b-48ed7bb1c19a" BLOCK_SIZE="1024" TYPE="ext4" PARTLABEL="primary" PARTUUID="4959facb-3d40-4346-96c8-35e4e08438f4"
/dev/md0p2: UUID="dbd0117d-c981-47d0-9c52-94920dd44a80" TYPE="swap" PARTLABEL="primary" PARTUUID="9acc48ee-83e9-431f-9aee-727e8c9142d1"
/dev/md0p3: UUID="9b9df18c-088e-44d9-a97e-dc83507fbff8" BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="primary" PARTUUID="3d57f288-ae15-4cea-9426-79f307750c47"
```

`cat /etc/fstab`
```
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# systemd generates mount units based on this file, see systemd.mount(5).
# Please run 'systemctl daemon-reload' after making changes here.
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda3 during installation
UUID=3e53b113-3ad6-4dcc-b314-f878e038ddd4 /               ext4    errors=remount-ro 0       1
# /boot was on /dev/sda1 during installation
UUID=e919b759-bc17-46b4-8e96-46db50940931 /boot           ext4    defaults        0       2
# swap was on /dev/sda2 during installation
UUID=f45c1e36-c502-45b2-be36-e998a704c0b6 none            swap    sw              0       0
/dev/sr0        /media/cdrom0   udf,iso9660 user,noauto     0       0
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
#VAGRANT-END
```

```
sed -i 's/3e53b113-3ad6-4dcc-b314-f878e038ddd4/9b9df18c-088e-44d9-a97e-dc83507fbff8/' /mnt/etc/fstab
sed -i 's/e919b759-bc17-46b4-8e96-46db50940931/13ed70e3-a531-4c30-9a3b-48ed7bb1c19a/' /mnt/etc/fstab
sed -i 's/f45c1e36-c502-45b2-be36-e998a704c0b6/dbd0117d-c981-47d0-9c52-94920dd44a80/' /mnt/etc/fstab
```

```
grub-install --root-directory=/mnt /dev/sdb
grub-install --root-directory=/mnt /dev/sdc
```

```
mount --bind /dev /mnt/dev
mount --bind /sys /mnt/sys
mount --bind /proc /mnt/proc

chroot /mnt

grub-mkconfig -o /boot/grub/grub.cfg

exit

umount /mnt/{dev,proc,sys}
cd /
umount /mnt/boot
umount /mnt

reboot
```


## Извлёк старый /dev/sda

`lsblk`
```
NAME        MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
sda           8:0    0   20G  0 disk
└─sda1        8:1    0   20G  0 part
  └─md0       9:0    0   20G  0 raid1
    ├─md0p1 259:0    0  487M  0 part  /boot
    ├─md0p2 259:1    0  1.9G  0 part  [SWAP]
    └─md0p3 259:2    0 17.6G  0 part  /
sdb           8:16   0   20G  0 disk
└─sdb1        8:17   0   20G  0 part
  └─md0       9:0    0   20G  0 raid1
    ├─md0p1 259:0    0  487M  0 part  /boot
    ├─md0p2 259:1    0  1.9G  0 part  [SWAP]
    └─md0p3 259:2    0 17.6G  0 part  /
```

`blkid`
```
/dev/sdb1: UUID="42c18d11-b0ef-2e7a-0cd2-466f27c07ef2" UUID_SUB="49b0debe-5021-20da-057a-769127f484d2" LABEL="disksubsystem:0" TYPE="linux_raid_member" PARTUUID="d2c9bc5f-01"
/dev/sda1: UUID="42c18d11-b0ef-2e7a-0cd2-466f27c07ef2" UUID_SUB="cad99d6d-1e88-009c-ec7d-380a647ee755" LABEL="disksubsystem:0" TYPE="linux_raid_member" PARTUUID="df96f95a-01"
/dev/md0p1: UUID="13ed70e3-a531-4c30-9a3b-48ed7bb1c19a" BLOCK_SIZE="1024" TYPE="ext4" PARTLABEL="primary" PARTUUID="4959facb-3d40-4346-96c8-35e4e08438f4"
/dev/md0p2: UUID="dbd0117d-c981-47d0-9c52-94920dd44a80" TYPE="swap" PARTLABEL="primary" PARTUUID="9acc48ee-83e9-431f-9aee-727e8c9142d1"
/dev/md0p3: UUID="9b9df18c-088e-44d9-a97e-dc83507fbff8" BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="primary" PARTUUID="3d57f288-ae15-4cea-9426-79f307750c47"
```
